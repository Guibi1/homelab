apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
    name: vaultwarden-cluster
    namespace: cnpg
spec:
    description: "Vaultwarden cluster"
    imageName: ghcr.io/cloudnative-pg/postgresql:16.2
    instances: 1
    startDelay: 300
    stopDelay: 300
    primaryUpdateStrategy: unsupervised

    postgresql:
        parameters:
            shared_buffers: 256MB
            pg_stat_statements.max: '10000'
            pg_stat_statements.track: all
            auto_explain.log_min_duration: '10s'

    bootstrap:
        initdb:
            database: vaultwarden
            owner: vaultwarden
            secret:
                name: vaultwarden-cluster-secret

    storage:
        storageClass: local-path
        size: 2Gi

    monitoring:
        enablePodMonitor: true

    resources:
        requests:
            memory: "512Mi"
            cpu: "1"
        limits:
            memory: "1Gi"
            cpu: "2"

    affinity:
        enablePodAntiAffinity: true
        topologyKey: failure-domain.beta.kubernetes.io/zone

    nodeMaintenanceWindow:
        inProgress: false
        reusePVC: false

---

apiVersion: v1
kind: Secret
type: kubernetes.io/basic-auth
metadata:
    name: vaultwarden-cluster-secret
    namespace: cnpg
data:
    username: dmF1bHR3YXJkZW4=
    password: dmF1bHR3YXJkZW4=
